angular.module("dndLists",[]).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","$window","dndDragFrom",function(e,n,r,t,a,d){return function(o,i,f){i.attr("draggable","true"),f.dndDisableIf&&o.$watch(f.dndDisableIf,function(e){i.attr("draggable",!e)}),i.on("dragstart",function(l){l=l.originalEvent||l;var g=o.$eval(f.dndDraggable);l.dataTransfer.setData("Text",angular.toJson(g)),a["dndList.draggedData"]=g;var s=i.parent("[dnd-list]");s.length>0&&(d.originList=e(s[0].attributes["dnd-list"].value)(o)),l.dataTransfer.effectAllowed=f.dndEffectAllowed||"move",i.addClass("dndDragging"),n(function(){i.addClass("dndDraggingSource")},0),r.dropEffect="none",t.isDragging=!0,t.dragType=f.dndType?o.$eval(f.dndType):void 0,e(f.dndDragstart)(o,{event:l})}),i.on("dragend",function(a){a=a.originalEvent||a;var d=r.dropEffect;o.$apply(function(){switch(d){case"move":e(f.dndMoved)(o,{event:a});break;case"copy":e(f.dndCopied)(o,{event:a});break;case"none":e(f.dndCanceled)(o,{event:a})}e(f.dndDragend)(o,{event:a,dropEffect:d})}),i.removeClass("dndDragging"),n(function(){i.removeClass("dndDraggingSource")},0),t.isDragging=!1}),i.on("click",function(n){f.dndSelected&&(n=n.originalEvent||n,o.$apply(function(){e(f.dndSelected)(o,{event:n})}),n.stopPropagation())}),i.on("selectstart",function(){this.dragDrop&&this.dragDrop()})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","$window","dndDragFrom",function(e,n,r,t,a,d){return function(o,i,f){function l(e,n,r){var t=m?e.offsetX||e.layerX:e.offsetY||e.layerY,a=m?n.offsetWidth:n.offsetHeight,d=m?n.offsetLeft:n.offsetTop;return d=r?d:0,d+a/2>t}function g(){var e;return angular.forEach(i.children(),function(n){var r=angular.element(n);r.hasClass("dndPlaceholder")&&(e=r)}),e||angular.element("<li class='dndPlaceholder'></li>")}function s(){return Array.prototype.indexOf.call(E.children,y)}function u(e){if(!t.isDragging&&!T)return!1;if(!p(e.dataTransfer.types))return!1;if(f.dndAllowedTypes&&t.isDragging){var n=o.$eval(f.dndAllowedTypes);if(angular.isArray(n)&&-1===n.indexOf(t.dragType))return!1}return f.dndDisableIf&&o.$eval(f.dndDisableIf)?!1:!0}function c(){return D.remove(),i.removeClass("dndDragover"),!0}function v(n,r,a,d){return e(n)(o,{event:r,index:a,item:d||void 0,external:!t.isDragging,type:t.isDragging?t.dragType:void 0})}function p(e){if(!e)return!0;for(var n=0;n<e.length;n++)if("Text"===e[n]||"text/plain"===e[n])return!0;return!1}var D=g(),y=D[0],E=i[0];D.remove();var m=f.dndHorizontalList&&o.$eval(f.dndHorizontalList),T=f.dndExternalSources&&o.$eval(f.dndExternalSources);i.on("dragover",function(e){if(e=e.originalEvent||e,!u(e))return!0;if(y.parentNode!=E&&i.append(D),e.target!==E){for(var n=e.target;n.parentNode!==E&&n.parentNode;)n=n.parentNode;n.parentNode===E&&n!==y&&(l(e,n)?E.insertBefore(y,n):E.insertBefore(y,n.nextSibling))}else if(l(e,y,!0))for(;y.previousElementSibling&&(l(e,y.previousElementSibling,!0)||0===y.previousElementSibling.offsetHeight);)E.insertBefore(y,y.previousElementSibling);else for(;y.nextElementSibling&&!l(e,y.nextElementSibling,!0);)E.insertBefore(y,y.nextElementSibling.nextElementSibling);return f.dndDragover&&!v(f.dndDragover,e,s())?c():(i.addClass("dndDragover"),e.preventDefault(),!1)}),i.on("drop",function(e){if(e=e.originalEvent||e,!u(e))return!0;e.preventDefault();var t=a["dndList.draggedData"];if(void 0===t){var i=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain");try{t=JSON.parse(i)}catch(l){return c()}}var g=s();if(f.dndDrop&&(t=v(f.dndDrop,e,g,t),!t))return c();var p=o.$eval(f.dndList);if(p==d.originList){var D=d.originList.indexOf(t);g>D&&g--,d.originList=void 0}return n(function(){p.splice(g,0,t),v(f.dndInserted,e,g,t),c()},0),r.dropEffect="none"===e.dataTransfer.dropEffect?"copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.effectAllowed:e.ctrlKey?"copy":"move":e.dataTransfer.dropEffect,e.stopPropagation(),!1}),i.on("dragleave",function(e){e=e.originalEvent||e,i.removeClass("dndDragover"),n(function(){i.hasClass("dndDragover")||D.remove()},100)})}}]).directive("dndNodrag",function(){return function(e,n){n.attr("draggable","true"),n.on("dragstart",function(e){e=e.originalEvent||e,e.dataTransfer.types&&e.dataTransfer.types.length||e.preventDefault(),e.stopPropagation()}),n.on("dragend",function(e){e=e.originalEvent||e,e.stopPropagation()})}}).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}}).factory("dndDragFrom",function(){return{originList:void 0}});
